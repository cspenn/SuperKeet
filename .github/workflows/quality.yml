name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install UV
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Cache UV dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: Install dependencies
      run: uv sync --all-groups

    - name: Lint with ruff
      run: |
        uv run ruff check superkeet/ tests/ --output-format=github --statistics
        uv run ruff format --check superkeet/ tests/

    - name: Security scan with bandit
      run: uv run bandit -r superkeet/ -ll -x tests/

    - name: Check code complexity
      run: |
        uv run radon cc superkeet/ --min=C --show-complexity
        uv run radon mi superkeet/ --min=B --show

    - name: Dead code detection
      run: |
        uv tool install vulture
        vulture superkeet/ --min-confidence=80 || echo "Vulture scan completed"
